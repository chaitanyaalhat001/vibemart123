{% extends 'base.html' %}
{% load static %}

{% block title %}Vendor Dashboard - VibeMart{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-store me-3"></i>Vendor Dashboard</h2>
                    <p class="text-muted">Welcome back, {{ user.first_name }} {{ user.last_name }}!</p>
                </div>
                <div>
                    <a href="#" class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#addProductModal">
                        <i class="fas fa-plus me-2"></i>Add Product
                    </a>
                    <a href="{% url 'accounts:profile' %}" class="btn btn-outline-primary">
                        <i class="fas fa-user me-2"></i>Profile
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card border-primary">
                <div class="card-body text-center">
                    <i class="fas fa-box fa-2x text-primary mb-2"></i>
                    <h4 class="text-primary">{{ total_products }}</h4>
                    <p class="text-muted mb-0">Total Products</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-success">
                <div class="card-body text-center">
                    <i class="fas fa-shopping-cart fa-2x text-success mb-2"></i>
                    <h4 class="text-success">{{ total_orders }}</h4>
                    <p class="text-muted mb-0">Total Orders</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-warning">
                <div class="card-body text-center">
                    <i class="fas fa-dollar-sign fa-2x text-warning mb-2"></i>
                    <h4 class="text-warning">${{ total_revenue|floatformat:2 }}</h4>
                    <p class="text-muted mb-0">Total Revenue</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-warning">
                <div class="card-body text-center">
                    <i class="fas fa-wallet fa-2x text-warning mb-2"></i>
                    <h4 class="text-warning">${{ user.wallet.balance|floatformat:2 }}</h4>
                    <p class="text-muted mb-0">Wallet Balance</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Orders & Products -->
    <div class="row">
        <!-- Recent Orders -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-receipt me-2"></i>Recent Orders</h5>
                </div>
                <div class="card-body">
                    {% if recent_orders %}
                        {% for order in recent_orders %}
                        <div class="d-flex justify-content-between align-items-center mb-3 pb-3 {% if not forloop.last %}border-bottom{% endif %}">
                            <div>
                                <h6 class="mb-1">Order #{{ order.order_id|slice:":8" }}...</h6>
                                <p class="text-muted small mb-0">{{ order.created_at|date:"M d, Y" }}</p>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-success">${{ order.total_amount }}</span><br>
                                <span class="badge bg-info">{{ order.get_status_display }}</span>
                            </div>
                        </div>
                        {% endfor %}
                        <div class="text-center">
                            <a href="#" class="btn btn-outline-primary btn-sm">View All Orders</a>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No orders yet</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- My Products -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-box me-2"></i>My Products</h5>
                </div>
                <div class="card-body">
                    {% if vendor_products %}
                        {% for product in vendor_products %}
                        <div class="d-flex align-items-center mb-3 pb-3 {% if not forloop.last %}border-bottom{% endif %}">
                            <img src="{% if product.image %}{{ product.image.url }}{% else %}{% static 'images/placeholder.svg' %}{% endif %}" 
                                 alt="{{ product.name }}" class="me-3" style="width: 50px; height: 50px; object-fit: cover;">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">{{ product.name|truncatechars:25 }}</h6>
                                <p class="text-muted small mb-0">${{ product.price }} | Stock: {{ product.stock }}</p>
                            </div>
                            <div>
                                <span class="badge {% if product.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                                    {% if product.is_active %}Active{% else %}Inactive{% endif %}
                                </span>
                            </div>
                        </div>
                        {% endfor %}
                        <div class="text-center">
                            <a href="#" class="btn btn-outline-primary btn-sm">Manage Products</a>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No products yet</p>
                            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addProductModal">
                                <i class="fas fa-plus me-1"></i>Add Your First Product
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-2 col-md-4 col-6 mb-3">
                            <button class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#addProductModal">
                                <i class="fas fa-plus fa-2x mb-2"></i><br>
                                Add Product
                            </button>
                        </div>
                        <div class="col-lg-2 col-md-4 col-6 mb-3">
                            <a href="{% url 'dashboard:vendor_analytics' %}" class="btn btn-outline-success w-100">
                                <i class="fas fa-chart-line fa-2x mb-2"></i><br>
                                View Analytics
                            </a>
                        </div>
                        <div class="col-lg-2 col-md-4 col-6 mb-3">
                            <a href="{% url 'dashboard:vendor_orders' %}" class="btn btn-outline-warning w-100">
                                <i class="fas fa-cog fa-2x mb-2"></i><br>
                                Manage Orders
                            </a>
                        </div>
                        <div class="col-lg-2 col-md-4 col-6 mb-3">
                            <a href="{% url 'dashboard:vendor_wallet' %}" class="btn btn-outline-success w-100">
                                <i class="fas fa-wallet fa-2x mb-2"></i><br>
                                Manage Wallet
                            </a>
                        </div>
                        <div class="col-lg-2 col-md-4 col-6 mb-3">
                            <a href="{% url 'accounts:profile' %}" class="btn btn-outline-info w-100">
                                <i class="fas fa-user fa-2x mb-2"></i><br>
                                Update Profile
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addProductModalLabel"><i class="fas fa-plus me-2"></i>Add New Product</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" enctype="multipart/form-data" action="{% url 'dashboard:add_product' %}">
                <div class="modal-body">
                    {% csrf_token %}
                    
                    <!-- Debug info (remove in production) -->
                    {% if categories %}
                        <div class="alert alert-info alert-dismissible fade show" role="alert">
                            <small><strong>Debug:</strong> {{ categories.count }} categories loaded successfully</small>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% else %}
                        <div class="alert alert-warning" role="alert">
                            <small><strong>Warning:</strong> No categories found. Please contact admin to add categories.</small>
                        </div>
                    {% endif %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="product_name" class="form-label">Product Name *</label>
                            <input type="text" class="form-control" id="product_name" name="name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="product_price" class="form-label">Price ($) *</label>
                            <input type="number" step="0.01" class="form-control" id="product_price" name="price" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="product_category" class="form-label">Category *</label>
                            <select class="form-select" id="product_category" name="category" required>
                                <option value="">-- Select Category --</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                                {% empty %}
                                <option value="">No categories available</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Choose the category that best fits your product</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="product_stock" class="form-label">Stock Quantity *</label>
                            <input type="number" class="form-control" id="product_stock" name="stock" min="0" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="product_description" class="form-label">Description *</label>
                        <textarea class="form-control" id="product_description" name="description" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="product_image" class="form-label">Product Image</label>
                        <input type="file" class="form-control" id="product_image" name="image" accept="image/*">
                        <div class="form-text">Upload a clear image of your product (optional)</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Add Product
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Handle modal form
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('addProductModal');
    const form = modal.querySelector('form');
    
    // Clear form when modal is hidden
    modal.addEventListener('hidden.bs.modal', function () {
        form.reset();
        // Remove any validation states
        form.querySelectorAll('.is-valid, .is-invalid').forEach(el => {
            el.classList.remove('is-valid', 'is-invalid');
        });
    });
    
    // Add form validation
    form.addEventListener('submit', function(e) {
        const requiredFields = form.querySelectorAll('[required]');
        let isValid = true;
        
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            } else {
                field.classList.remove('is-invalid');
                field.classList.add('is-valid');
            }
        });
        
        if (!isValid) {
            e.preventDefault();
            alert('Please fill in all required fields.');
        }
    });
    
    // Real-time validation
    form.querySelectorAll('[required]').forEach(field => {
        field.addEventListener('blur', function() {
            if (this.value.trim()) {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            } else {
                this.classList.remove('is-valid');
                this.classList.add('is-invalid');
            }
        });
    });
});
</script>

<style>
.modal-dialog-centered {
    min-height: calc(100vh - 60px);
}

.form-select:focus,
.form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.alert-info {
    background-color: #d1ecf1;
    border-color: #bee5eb;
    color: #0c5460;
}

.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: 1px solid rgba(0, 0, 0, 0.125);
}

.card:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    transition: box-shadow 0.15s ease-in-out;
}
</style>
{% endblock %} 